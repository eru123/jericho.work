name: Production

on:
    push:
        branches: [production]

jobs:
    deploy:
        environment: 
            name: Production
            url: https://skiddph.com
        name: Deploy
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Repository
              uses: actions/checkout@v3

            - name: Generate .env file
              uses: skiddph/actions-env@v1.0.1
              with:
                file: html/.env
                prefix: ENV_
              env:
                ENV_APP_ENV: production
                ENV_BASE_URL: https://skiddph.com
                ENV_DOMAIN: skiddph.com
                ENV_CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
                ENV_CF_ZONE_ID: ${{ secrets.CF_ZONE_ID }}
                ENV_CF_EMAIL: ${{ secrets.CF_EMAIL }}
                ENV_CF_GLOBAL_API_KEY: ${{ secrets.CF_GLOBAL_API_KEY }}
                ENV_CF_ORIGIN_CA_KEY: ${{ secrets.CF_ORIGIN_CA_KEY }}
                ENV_CF_R2_HOST: ${{ secrets.CF_R2_HOST }}
                ENV_CF_R2_BUCKET: ${{ secrets.CF_R2_BUCKET }}
                ENV_CF_R2_ACCESS_KEY_ID: ${{ secrets.CF_R2_ACCESS_KEY_ID }}
                ENV_CF_R2_API_KEY: ${{ secrets.CF_R2_API_KEY }}
                ENV_CF_CACHE_TOKEN: ${{ secrets.CF_CACHE_TOKEN }}
                ENV_DB_HOST: ${{ secrets.DB_HOST }}
                ENV_DB_PORT: ${{ secrets.DB_PORT }}
                ENV_DB_USER: ${{ secrets.DB_USER }}
                ENV_DB_PASS: ${{ secrets.DB_PASS }}
                ENV_DB_NAME: ${{ secrets.DB_NAME }}
                ENV_MEMCACHED_HOST: ${{ secrets.MEMCACHED_HOST }}
                ENV_MEMCACHED_PORT: ${{ secrets.MEMCACHED_PORT }}
                ENV_SMTP_HOST: ${{ secrets.SMTP_HOST }}
                ENV_SMTP_USER: ${{ secrets.SMTP_USER }}
                ENV_SMTP_PASS: ${{ secrets.SMTP_PASS }}
                ENV_SMTP_FROM_NAME: ${{ secrets.SMTP_FROM_NAME }}
                ENV_SMTP_FROM_EMAIL: ${{ secrets.SMTP_FROM_EMAIL }}
            
            - name: Cache Composer dependencies
              uses: actions/cache@v3
              with:
                path: /tmp/composer-cache
                key: ${{ runner.os }}-${{ hashFiles('**/composer.lock') }}
                
            - name: Install Composer Dependencies
              uses: php-actions/composer@v6
              with:
                dev: no
                args: --profile --ignore-platform-reqs -o

            - name: Sync files
              uses: SamKirkland/FTP-Deploy-Action@4.3.0
              with:
                  protocol: ftp
                  server: ${{secrets.FTP_SERVER}}
                  username: ${{secrets.FTP_USERNAME}}
                  password: ${{secrets.FTP_PASSWORD}}
                  server-dir: ${{secrets.FTP_SERVER_DIR}}
                  local-dir: html
                  state-name: production-sync-state.json